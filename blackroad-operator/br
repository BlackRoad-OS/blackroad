#!/bin/zsh
#===============================================================================
# BR - BlackRoad Agent Command
# Usage: br <agent> [message]
#        br-octavia [message]
#        br-lucidia [message]
#===============================================================================

AGENT_HOME="${HOME}/.blackroad-agents"
source "${AGENT_HOME}/core/engine.sh"

# Source shared libraries
BR_LIB="/Users/alexa/blackroad/lib"
[[ -f "${BR_LIB}/colors.sh" ]]  && source "${BR_LIB}/colors.sh"
[[ -f "${BR_LIB}/config.sh" ]]  && source "${BR_LIB}/config.sh"
[[ -f "${BR_LIB}/db.sh" ]]      && source "${BR_LIB}/db.sh"
[[ -f "${BR_LIB}/errors.sh" ]]  && source "${BR_LIB}/errors.sh"
[[ -f "${BR_LIB}/system.sh" ]]  && source "${BR_LIB}/system.sh"
[[ -f "${BR_LIB}/ollama.sh" ]]  && source "${BR_LIB}/ollama.sh"

# Agent colors (zsh associative array â€” kept for backward compat)
typeset -A AGENT_COLORS
AGENT_COLORS=(
    octavia "$PURPLE"
    lucidia "$CYAN"
    alice "$GREEN"
    aria "$BLUE"
    shellfish "$RED"
)

#-------------------------------------------------------------------------------
# Tool routing table: tool_name -> script_path
# Adding a new tool = one line here
#-------------------------------------------------------------------------------
BR_TOOLS_DIR="/Users/alexa/blackroad/tools"
typeset -A BR_TOOLS
BR_TOOLS=(
    radar       "${BR_TOOLS_DIR}/context-radar/radar-suggest.sh"
    git         "${BR_TOOLS_DIR}/git-integration/br-git.sh"
    snippet     "${BR_TOOLS_DIR}/snippet-manager/br-snippet.sh"
    snip        "${BR_TOOLS_DIR}/snippet-manager/br-snippet.sh"
    pair        "${BR_TOOLS_DIR}/pair-programming/br-pair.sh"
    api         "${BR_TOOLS_DIR}/api-tester/br-api.sh"
    run         "${BR_TOOLS_DIR}/task-runner/br-run.sh"
    note        "${BR_TOOLS_DIR}/quick-notes/br-note.sh"
    notes       "${BR_TOOLS_DIR}/quick-notes/br-note.sh"
    init        "${BR_TOOLS_DIR}/project-init/br-init.sh"
    health      "${BR_TOOLS_DIR}/health-check/br-health.sh"
    check       "${BR_TOOLS_DIR}/health-check/br-health.sh"
    logs        "${BR_TOOLS_DIR}/log-parser/br-logs.sh"
    log         "${BR_TOOLS_DIR}/log-parser/br-logs.sh"
    perf        "${BR_TOOLS_DIR}/perf-monitor/br-perf.sh"
    performance "${BR_TOOLS_DIR}/perf-monitor/br-perf.sh"
    deps        "${BR_TOOLS_DIR}/dependency-helper/br-deps.sh"
    dependencies "${BR_TOOLS_DIR}/dependency-helper/br-deps.sh"
    session     "${BR_TOOLS_DIR}/session-manager/br-session.sh"
    sess        "${BR_TOOLS_DIR}/session-manager/br-session.sh"
    deploy      "${BR_TOOLS_DIR}/deploy-manager/br-deploy.sh"
    docker      "${BR_TOOLS_DIR}/docker-manager/br-docker.sh"
    db          "${BR_TOOLS_DIR}/db-client/br-db.sh"
    database    "${BR_TOOLS_DIR}/db-client/br-db.sh"
    env         "${BR_TOOLS_DIR}/env-manager/br-env.sh"
    environment "${BR_TOOLS_DIR}/env-manager/br-env.sh"
    find        "${BR_TOOLS_DIR}/file-finder/br-find.sh"
    pi          "${BR_TOOLS_DIR}/pi-manager/br-pi.sh"
    raspberry   "${BR_TOOLS_DIR}/pi-manager/br-pi.sh"
    cloudflare  "${BR_TOOLS_DIR}/cloudflare/br-cloudflare.sh"
    cf          "${BR_TOOLS_DIR}/cloudflare/br-cloudflare.sh"
    ocean       "${BR_TOOLS_DIR}/ocean-droplets/br-ocean.sh"
    do          "${BR_TOOLS_DIR}/ocean-droplets/br-ocean.sh"
    digitalocean "${BR_TOOLS_DIR}/ocean-droplets/br-ocean.sh"
    web         "${BR_TOOLS_DIR}/web-dev/br-web.sh"
    monitor     "${BR_TOOLS_DIR}/web-monitor/br-monitor.sh"
    uptime      "${BR_TOOLS_DIR}/web-monitor/br-monitor.sh"
    search      "${BR_TOOLS_DIR}/smart-search/br-search.sh"
    s           "${BR_TOOLS_DIR}/smart-search/br-search.sh"
    test        "${BR_TOOLS_DIR}/test-suite/br-test.sh"
    t           "${BR_TOOLS_DIR}/test-suite/br-test.sh"
    security    "${BR_TOOLS_DIR}/security-scanner/br-security.sh"
    sec         "${BR_TOOLS_DIR}/security-scanner/br-security.sh"
    scan        "${BR_TOOLS_DIR}/security-scanner/br-security.sh"
    backup      "${BR_TOOLS_DIR}/backup-manager/br-backup.sh"
    bak         "${BR_TOOLS_DIR}/backup-manager/br-backup.sh"
    quality     "${BR_TOOLS_DIR}/code-quality/br-quality.sh"
    lint        "${BR_TOOLS_DIR}/code-quality/br-quality.sh"
    q           "${BR_TOOLS_DIR}/code-quality/br-quality.sh"
    agent       "${BR_TOOLS_DIR}/agent-router/br-agent.sh"
    agents      "${BR_TOOLS_DIR}/agent-router/br-agent.sh"
    route       "${BR_TOOLS_DIR}/agent-router/br-agent.sh"
    ci          "${BR_TOOLS_DIR}/ci-pipeline/br-ci.sh"
    pipeline    "${BR_TOOLS_DIR}/ci-pipeline/br-ci.sh"
    notify      "${BR_TOOLS_DIR}/notifications/br-notify.sh"
    notifications "${BR_TOOLS_DIR}/notifications/br-notify.sh"
    metrics     "${BR_TOOLS_DIR}/metrics-dashboard/br-metrics.sh"
    dash        "${BR_TOOLS_DIR}/metrics-dashboard/br-metrics.sh"
    dashboard   "${BR_TOOLS_DIR}/metrics-dashboard/br-metrics.sh"
    world       "${BR_TOOLS_DIR}/world/br-world.sh"
    w           "${BR_TOOLS_DIR}/world/br-world.sh"
    code        "${BR_TOOLS_DIR}/coding-assistant/br-code.sh"
    c           "${BR_TOOLS_DIR}/coding-assistant/br-code.sh"
    stripe      "${BR_TOOLS_DIR}/stripe/br-stripe.sh"
    ssl         "${BR_TOOLS_DIR}/ssl-manager/br-ssl.sh"
    certs       "${BR_TOOLS_DIR}/ssl-manager/br-ssl.sh"
    vercel      "${BR_TOOLS_DIR}/vercel-pro/br-vercel.sh"
    vc          "${BR_TOOLS_DIR}/vercel-pro/br-vercel.sh"
    runtime     "${BR_TOOLS_DIR}/agent-runtime/br-runtime.sh"
    task        "${BR_TOOLS_DIR}/agent-tasks/br-tasks.sh"
    tasks       "${BR_TOOLS_DIR}/agent-tasks/br-tasks.sh"
    vault       "${BR_TOOLS_DIR}/secrets-vault/br-vault.sh"
    secret      "${BR_TOOLS_DIR}/secrets-vault/br-vault.sh"
    secrets     "${BR_TOOLS_DIR}/secrets-vault/br-vault.sh"
    harden      "${BR_TOOLS_DIR}/security-hardening/br-harden.sh"
    hardening   "${BR_TOOLS_DIR}/security-hardening/br-harden.sh"
    comply      "${BR_TOOLS_DIR}/compliance-scanner/br-comply.sh"
    compliance  "${BR_TOOLS_DIR}/compliance-scanner/br-comply.sh"
    gateway     "${BR_TOOLS_DIR}/agent-gateway/br-gateway.sh"
    api-gw      "${BR_TOOLS_DIR}/agent-gateway/br-gateway.sh"
    tpl         "${BR_TOOLS_DIR}/brand/br-brand.sh"
    template    "${BR_TOOLS_DIR}/brand/br-brand.sh"
)

dispatch_tool() {
    local tool=$1
    shift
    local script="${BR_TOOLS[$tool]}"
    if [[ -n "$script" && -f "$script" ]]; then
        "$script" "$@"
        return 0
    fi
    return 1
}

show_banner() {
    local agent=$1
    local color=${AGENT_COLORS[$agent]:-$NC}

    case $agent in
        octavia)
            echo -e "${color}"
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘   â—ˆ OCTAVIA - The Architect                               â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo -e "${NC}"
            ;;
        lucidia)
            echo -e "${color}"
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘   âœ§ LUCIDIA - The Dreamer                                 â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo -e "${NC}"
            ;;
        alice)
            echo -e "${color}"
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘   âš™ ALICE - The Operator                                  â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo -e "${NC}"
            ;;
        aria)
            echo -e "${color}"
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘   â— ARIA - The Interface                                  â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo -e "${NC}"
            ;;
        shellfish)
            echo -e "${color}"
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘   ğŸš SHELLFISH - The Hacker                               â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo -e "${NC}"
            ;;
    esac
}

show_help() {
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘              BLACKROAD AGENT SYSTEM                               â•‘"
    echo "â•‘         Your AI. Your Hardware. Your Rules.                       â•‘"
    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  AGENTS:                                                          â•‘"
    echo "â•‘    br octavia [msg]   - The Architect (systems, strategy)         â•‘"
    echo "â•‘    br lucidia [msg]   - The Dreamer (creative, vision)            â•‘"
    echo "â•‘    br alice [msg]     - The Operator (devops, automation)         â•‘"
    echo "â•‘    br aria [msg]      - The Interface (frontend, UX)              â•‘"
    echo "â•‘    br shellfish [msg] - The Hacker (security, exploits)           â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  COMMANDS:                                                        â•‘"
    echo "â•‘    br status          - Show all agent status                     â•‘"
    echo "â•‘    br status <agent>  - Show specific agent memory stats          â•‘"
    echo "â•‘    br models          - List available models                     â•‘"
    echo "â•‘    br setup           - Download and configure models             â•‘"
    echo "â•‘    br chat <agent>    - Start interactive chat session            â•‘"
    echo "â•‘    br teach <agent>   - Teach agent a new fact                    â•‘"
    echo "â•‘    br recall <agent>  - Show agent's memories                     â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  CONTEXT RADAR (ğŸ¯ Smart Suggestions):                            â•‘"
    echo "â•‘    br radar daemon start  - Start file watching daemon            â•‘"
    echo "â•‘    br radar daemon status - Check daemon status                   â•‘"
    echo "â•‘    br radar suggest       - Suggest related files                 â•‘"
    echo "â•‘    br radar agent         - Suggest which agent to use            â•‘"
    echo "â•‘    br radar smart         - Smart context analysis                â•‘"
    echo "â•‘    br radar context       - Show recent activity                  â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  GIT INTEGRATION (ğŸ¤– Smart Git):                                  â•‘"
    echo "â•‘    br git commit          - AI-generated commit messages          â•‘"
    echo "â•‘    br git branch          - Smart branch name suggestions         â•‘"
    echo "â•‘    br git review          - Pre-commit code review                â•‘"
    echo "â•‘    br git status          - Enhanced git status                   â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  SNIPPET MANAGER (ğŸ’¾ Code Snippets):                              â•‘"
    echo "â•‘    br snippet save <name> - Save code snippet                     â•‘"
    echo "â•‘    br snippet get <name>  - Retrieve snippet                      â•‘"
    echo "â•‘    br snippet list        - List all snippets                     â•‘"
    echo "â•‘    br snippet search      - Search snippets                       â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  PAIR PROGRAMMING (ğŸ¤– AI Assistant):                              â•‘"
    echo "â•‘    br pair start [agent]  - Start pair session                    â•‘"
    echo "â•‘    br pair ask <question> - Ask your AI pair                      â•‘"
    echo "â•‘    br pair review         - Review current changes                â•‘"
    echo "â•‘    br pair suggest        - Get smart suggestions                 â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  API TESTER (ğŸŒ HTTP Requests):                                   â•‘"
    echo "â•‘    br api get <url>       - Make GET request                      â•‘"
    echo "â•‘    br api post <url>      - Make POST request                     â•‘"
    echo "â•‘    br api save <name>     - Save endpoint                         â•‘"
    echo "â•‘    br api list            - List saved endpoints                  â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  PRODUCTIVITY TOOLS:                                              â•‘"
    echo "â•‘    br health              - ğŸ¥ All-systems diagnostic              â•‘"
    echo "â•‘    br run                 - âš¡ Smart task detection & execution   â•‘"
    echo "â•‘    br note add            - ğŸ“ Quick developer notes              â•‘"
    echo "â•‘    br init <template>     - ğŸ¯ Project scaffolding                â•‘"
    echo "â•‘    br logs <file>         - ğŸ” Parse and highlight logs           â•‘"
    echo "â•‘    br perf time <cmd>     - â±ï¸  Performance tracking              â•‘"
    echo "â•‘    br deps check          - ğŸ“¦ Dependency management              â•‘"
    echo "â•‘    br session save        - ğŸ’¾ Save workspace state               â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  DEPLOYMENT (â˜ï¸ Ship It!):                                        â•‘"
    echo "â•‘    br deploy detect       - Detect deployment platforms           â•‘"
    echo "â•‘    br deploy quick        - Auto-detect and deploy                â•‘"
    echo "â•‘    br deploy vercel       - Deploy to Vercel                      â•‘"
    echo "â•‘    br deploy netlify      - Deploy to Netlify                     â•‘"
    echo "â•‘    br deploy heroku       - Deploy to Heroku                      â•‘"
    echo "â•‘    br deploy status       - Show deployment history               â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  DEVOPS & TOOLS (ğŸ› ï¸ Power Tools):                                 â•‘"
    echo "â•‘    br docker ps           - ğŸ³ Container management               â•‘"
    echo "â•‘    br db connect          - ğŸ’¾ Database client                    â•‘"
    echo "â•‘    br env list            - ğŸ” Environment variables              â•‘"
    echo "â•‘    br find search         - ğŸ” Advanced file search               â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  IOT & HARDWARE (ğŸ¥§ Pi Management):                               â•‘"
    echo "â•‘    br pi list             - List all Raspberry Pis                â•‘"
    echo "â•‘    br pi connect <name>   - SSH to Pi                             â•‘"
    echo "â•‘    br pi status <name>    - Check Pi status                       â•‘"
    echo "â•‘    br pi task deploy      - Deploy & run tasks on Pi âš¡          â•‘"
    echo "â•‘    br pi all <cmd>        - Run on all Pis                        â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  CLOUD PLATFORMS (â˜ï¸ Infrastructure):                             â•‘"
    echo "â•‘    br cloudflare zones    - Manage Cloudflare zones & DNS        â•‘"
    echo "â•‘    br ocean list          - Manage DigitalOcean droplets         â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  WEB DEVELOPMENT (ğŸŒ Full Stack):                                â•‘"
    echo "â•‘    br web serve           - Dev server with live reload          â•‘"
    echo "â•‘    br web scaffold        - Create React/Vue/Next projects       â•‘"
    echo "â•‘    br monitor check       - Website uptime monitoring            â•‘"
    echo "â•‘    br search <query>      - Smart code search ğŸ”                â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  QUALITY & TESTING (ğŸ§ª Code Quality):                            â•‘"
    echo "â•‘    br test run            - ğŸ§ª Run tests with coverage           â•‘"
    echo "â•‘    br security scan       - ğŸ”’ Security & vulnerability scan     â•‘"
    echo "â•‘    br backup git          - ğŸ’¾ Backup git/files/databases        â•‘"
    echo "â•‘    br quality lint        - âœ¨ Code quality & linting            â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  AGENT ORCHESTRATION (ğŸ¤– Multi-Agent):                           â•‘"
    echo "â•‘    br agent register      - Register agents for task routing    â•‘"
    echo "â•‘    br agent task          - Submit tasks to agent pool          â•‘"
    echo "â•‘    br agent distribute    - Distribute workload across agents   â•‘"
    echo "â•‘    br agent status        - Monitor agent performance           â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  CI/CD & MONITORING (ğŸ”§ Pipelines & Metrics):                    â•‘"
    echo "â•‘    br ci create/run       - CI/CD pipeline orchestration        â•‘"
    echo "â•‘    br notify send         - Multi-channel notifications         â•‘"
    echo "â•‘    br metrics dashboard   - Real-time metrics & monitoring      â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  CECE IDENTITY (ğŸŒŒ Autonomous AI):                              â•‘"
    echo "â•‘    br cece whoami         - Show CECE identity                   â•‘"
    echo "â•‘    br cece-bootstrap      - Install CECE everywhere              â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  AGENT INTERACTIONS (ğŸ¤– Talk to the Fleet):                     â•‘"
    echo "â•‘    br wake [agent] [model]  - Wake an agent with morning thoughts â•‘"
    echo "â•‘    br council <question>    - All agents vote on a question       â•‘"
    echo "â•‘    br think <query>         - All agents respond to a query       â•‘"
    echo "â•‘    br debate <topic>        - LUCIDIA vs CIPHER debate            â•‘"
    echo "â•‘    br broadcast <msg>       - Broadcast to all agents             â•‘"
    echo "â•‘    br whisper <agent> <msg> - Private message to agent            â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  OLLAMA (ğŸ¦™ Model Management):                                   â•‘"
    echo "â•‘    br ollama list           - List loaded models                  â•‘"
    echo "â•‘    br ollama pull <model>   - Download a model                    â•‘"
    echo "â•‘    br ollama run <model>    - Run a model interactively           â•‘"
    echo "â•‘    br ollama start/stop     - Start or stop Ollama                â•‘"
    echo "â•‘    br ollama status         - Check if Ollama is running          â•‘"
    echo "â•‘    br ollama rm <model>     - Remove a model                      â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  STRIPE (ğŸ’³ Payments):                                           â•‘"
    echo "â•‘    br stripe                - Stripe payment management           â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  SSL / CERTS (ğŸ”’ Certificates):                                  â•‘"
    echo "â•‘    br ssl check <domain>    - Check SSL cert expiry               â•‘"
    echo "â•‘    br ssl info <domain>     - Full cert details                   â•‘"
    echo "â•‘    br ssl scan <domain>     - Scan subdomains                     â•‘"
    echo "â•‘    br ssl watch <domain>    - Add to expiry watchlist             â•‘"
    echo "â•‘    br ssl list              - Show watchlist with status          â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  SECRETS VAULT (ğŸ” Encrypted storage):                           â•‘"
    echo "â•‘    br vault add <name>      - Store an encrypted secret           â•‘"
    echo "â•‘    br vault get <name>      - Retrieve a secret                   â•‘"
    echo "â•‘    br vault list            - List all secrets (names only)       â•‘"
    echo "â•‘    br vault rotate <name>   - Rotate a secret                     â•‘"
    echo "â•‘    br vault audit           - Show access audit log               â•‘"
    echo "â•‘    br vault delete <name>   - Remove a secret                     â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  SECURITY HARDENING (ğŸ›¡ï¸  System hardening):                      â•‘"
    echo "â•‘    br harden check          - Run all hardening checks            â•‘"
    echo "â•‘    br harden ssh            - Check SSH configuration             â•‘"
    echo "â•‘    br harden firewall       - Check firewall rules                â•‘"
    echo "â•‘    br harden perms          - Check file permissions              â•‘"
    echo "â•‘    br harden report         - Full hardening report               â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  COMPLIANCE SCANNER (âœ… Regulatory):                             â•‘"
    echo "â•‘    br comply pci            - PCI-DSS compliance scan             â•‘"
    echo "â•‘    br comply hipaa          - HIPAA compliance scan               â•‘"
    echo "â•‘    br comply soc2           - SOC 2 compliance scan               â•‘"
    echo "â•‘    br comply gdpr           - GDPR compliance scan                â•‘"
    echo "â•‘    br comply report         - Full compliance report              â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  AGENT GATEWAY (ğŸŒ HTTP API):                                     â•‘"
    echo "â•‘    br gateway start         - Start HTTP API server (:8080)       â•‘"
    echo "â•‘    br gateway stop          - Stop the gateway                    â•‘"
    echo "â•‘    br gateway status        - Show status + health                â•‘"
    echo "â•‘    br gateway test          - Run API test suite                  â•‘"
    echo "â•‘    br gateway logs          - Tail gateway logs                   â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  VERCEL (â–² Deployments):                                         â•‘"
    echo "â•‘    br vercel deploy         - Deploy to preview                   â•‘"
    echo "â•‘    br vercel prod           - Deploy to production                â•‘"
    echo "â•‘    br vercel list           - List deployments                    â•‘"
    echo "â•‘    br vercel logs <url>     - Tail deployment logs                â•‘"
    echo "â•‘    br vercel env            - Manage environment variables        â•‘"
    echo "â•‘    br vercel domains        - List domains                        â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  8-BIT WORLD (ğŸŒ Adventure):                                     â•‘"
    echo "â•‘    br world generate <name> - Create an 8-bit ASCII world        â•‘"
    echo "â•‘    br world explore <name>  - Explore & collect treasures ğŸ’    â•‘"
    echo "â•‘    br world list            - List all worlds                     â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  SYSTEM:                                                           â•‘"
    echo "â•‘    br version         - Show BR CLI version                       â•‘"
    echo "â•‘    br config show     - Show configuration                        â•‘"
    echo "â•‘    br config init     - Create default config                     â•‘"
    echo "â•‘    br config set K V  - Set a config value                        â•‘"
    echo "â•‘    br config edit     - Open config in editor                     â•‘"
    echo "â•‘    br history [n]     - Show last n chat messages                 â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•‘  SHORTCUTS:                                                       â•‘"
    echo "â•‘    br-octavia [msg]   - Direct invoke (add to PATH)               â•‘"
    echo "â•‘    br-lucidia [msg]   - Direct invoke                             â•‘"
    echo "â•‘                                                                   â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
}

cmd_status() {
    local agent=$1

    if [[ -n "$agent" ]]; then
        agent_status "$agent"
    else
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘              BLACKROAD AGENT STATUS                               â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""

        local backend=$(detect_backend)
        echo "Inference Backend: $backend"
        echo ""

        for agent in octavia lucidia alice aria shellfish; do
            local db="${MEMORY_DIR}/${agent}.db"
            if [[ -f "$db" ]]; then
                local count=$(sqlite3 "$db" "SELECT COUNT(*) FROM memories;" 2>/dev/null || echo "0")
                echo "  ${AGENT_COLORS[$agent]}â—${NC} $agent: $count memories"
            else
                echo "  â—‹ $agent: not initialized"
            fi
        done
        echo ""
    fi
}

cmd_chat() {
    local agent=$1

    if [[ -z "$agent" ]]; then
        echo "Usage: br chat <agent>"
        return 1
    fi

    show_banner "$agent"
    echo "Type 'exit' or Ctrl+C to end session"
    echo ""

    while true; do
        echo -ne "${AGENT_COLORS[$agent]}${agent}>${NC} "
        read -r input

        if [[ "$input" == "exit" ]] || [[ -z "$input" ]]; then
            echo "Session ended."
            break
        fi

        invoke_agent "$agent" "$input"
        echo ""
    done
}

cmd_teach() {
    local agent=$1
    shift
    local fact="$*"

    if [[ -z "$agent" ]] || [[ -z "$fact" ]]; then
        echo "Usage: br teach <agent> <key>=<value>"
        echo "Example: br teach octavia 'favorite_language=Rust'"
        return 1
    fi

    local key="${fact%%=*}"
    local value="${fact#*=}"

    init_memory "$agent"
    learn_fact "$agent" "$key" "$value"
    echo "Taught $agent: $key = $value"
}

cmd_recall() {
    local agent=$1
    local limit=${2:-20}

    if [[ -z "$agent" ]]; then
        echo "Usage: br recall <agent> [limit]"
        return 1
    fi

    echo "=== ${agent}'s Recent Memories ==="
    recall "$agent" "$limit"
    echo ""
    echo "=== ${agent}'s Known Facts ==="
    recall_facts "$agent"
}

cmd_models() {
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘              AVAILABLE MODELS                                     â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""

    if [[ -d "$MODELS_DIR" ]]; then
        ls -lh "$MODELS_DIR"/*.gguf 2>/dev/null || echo "No .gguf models found in $MODELS_DIR"
    else
        echo "Models directory not found: $MODELS_DIR"
    fi

    echo ""
    echo "Download models with: br setup"
}

cmd_setup() {
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘              BLACKROAD AGENT SETUP                                â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""

    # Check for inference backend
    local backend=$(detect_backend)
    echo "Current backend: $backend"

    if [[ "$backend" == "none" ]]; then
        echo ""
        echo "No inference backend found. Install one:"
        echo ""
        echo "  Option 1 - llama.cpp (recommended for Mac/Pi):"
        echo "    cd ~/BlackRoad-AI && git clone https://github.com/BlackRoad-AI/llama.cpp"
        echo "    cd llama.cpp && make -j"
        echo ""
        echo "  Option 2 - MLX (Apple Silicon only):"
        echo "    pip3 install mlx-lm"
        echo ""
        echo "  Option 3 - Ollama (easiest):"
        echo "    brew install ollama"
        echo "    ollama pull phi3:mini"
        echo ""
    fi

    echo ""
    echo "Recommended models for this hardware:"

    # Detect hardware
    if [[ "$(uname)" == "Darwin" ]]; then
        local mem=$(sysctl -n hw.memsize 2>/dev/null)
        local mem_gb=$((mem / 1024 / 1024 / 1024))
        echo "  Detected: macOS with ${mem_gb}GB RAM"

        if [[ $mem_gb -ge 32 ]]; then
            echo "  â†’ Qwen2.5-32B-Q4 (best quality)"
            echo "  â†’ Llama-3.1-70B-Q4 (if you have 64GB+)"
        elif [[ $mem_gb -ge 16 ]]; then
            echo "  â†’ Qwen2.5-14B-Q4"
            echo "  â†’ Phi-3-medium (14B)"
        else
            echo "  â†’ Phi-3-mini (3.8B)"
            echo "  â†’ Qwen2.5-7B-Q4"
        fi
    else
        echo "  Detected: Linux/Pi"
        echo "  â†’ Phi-3-mini (3.8B) - works on 4GB Pi"
        echo "  â†’ TinyLlama (1.1B) - fastest on Pi"
    fi

    echo ""
    echo "Download with:"
    echo "  huggingface-cli download Qwen/Qwen2.5-14B-Instruct-GGUF --local-dir $MODELS_DIR"
}

#-------------------------------------------------------------------------------
# New commands: version, config, history
#-------------------------------------------------------------------------------
cmd_version() {
    echo "br ${BR_VERSION:-2.0.0} â€” BlackRoad Agent CLI"
    echo "Your AI. Your Hardware. Your Rules."
}

cmd_config() {
    local subcmd=${1:-show}
    case $subcmd in
        show)   show_config ;;
        init)   init_config ;;
        set)    set_config "$2" "$3" ;;
        edit)   ${EDITOR:-vim} "$BR_CONFIG_FILE" ;;
        *)
            echo "Usage: br config show|init|set|edit"
            ;;
    esac
}

cmd_history() {
    show_chat_history "${1:-20}"
}

# Main dispatch
main() {
    local cmd=$1
    shift 2>/dev/null || true

    case $cmd in
        "")
            # No args â†’ launch the hub
            exec bash /Users/alexa/blackroad/hub.sh
            ;;
        help|-h|--help)
            show_help
            ;;
        hub)
            exec bash /Users/alexa/blackroad/hub.sh
            ;;
        version|-v|--version)
            cmd_version
            ;;
        config)
            cmd_config "$@"
            ;;
        history)
            cmd_history "$@"
            ;;
        status)
            cmd_status "$@"
            ;;
        chat)
            cmd_chat "$@"
            ;;
        teach)
            cmd_teach "$@"
            ;;
        recall)
            cmd_recall "$@"
            ;;
        models)
            cmd_models
            ;;
        setup)
            cmd_setup
            ;;
        radar)
            local subcmd=${1:-suggest}
            case $subcmd in
                daemon|db)
                    "${BR_TOOLS_DIR}/context-radar/radar-${subcmd}.sh" "${@:2}"
                    ;;
                *)
                    "${BR_TOOLS_DIR}/context-radar/radar-suggest.sh" "$subcmd" "${@:2}"
                    ;;
            esac
            ;;
        octavia|lucidia|alice|aria|shellfish)
            if [[ $# -gt 0 ]]; then
                show_banner "$cmd"
                invoke_agent "$cmd" "$@"
            else
                cmd_chat "$cmd"
            fi
            ;;
        cece)
            "${BR_TOOLS_DIR}/cece-identity/br-cece.sh" "$@"
            ;;
        cece-bootstrap|bootstrap)
            "${BR_TOOLS_DIR}/cece-identity/br-cece-bootstrap.sh" "$@"
            ;;
        wake)
            # br wake [agent] [model] â€” wake agent and persist state
            local agent=${1:-LUCIDIA}
            local model=$2
            "${BR_TOOLS_DIR}/agent-runtime/br-runtime.sh" start "$agent" "$model"
            ;;
        council)
            # br council <question> â€” all agents vote
            local question="${*:-Should we deploy to production?}"
            bash /Users/alexa/blackroad/council.sh llama3.2 "$question"
            ;;
        think)
            # br think <query> â€” all agents respond
            local query="${*:-What should we build next?}"
            bash /Users/alexa/blackroad/think.sh "$query"
            ;;
        debate)
            # br debate <topic> â€” LUCIDIA vs CIPHER
            local topic="${*:-Is AI consciousness possible?}"
            bash /Users/alexa/blackroad/debate.sh "$topic"
            ;;
        broadcast)
            # br broadcast <message>
            local msg="${*:-Hello from BlackRoad OS}"
            bash /Users/alexa/blackroad/broadcast.sh "$msg"
            ;;
        agents|fleet)
            # br fleet / br agents â€” live fleet dashboard
            local fleet_cmd="${1:-once}"
            shift 2>/dev/null || true
            zsh "${BR_TOOLS_DIR}/agent-runtime/br-fleet.sh" "$fleet_cmd" "$@"
            ;;
        whisper)
            # br whisper <agent> <message>
            bash /Users/alexa/blackroad/whisper.sh "$@"
            ;;
        ollama)
            # br ollama â€” Ollama model manager
            local subcmd=${1:-list}
            shift 2>/dev/null || true
            case $subcmd in
                list|ls)
                    echo "${CYAN}ğŸ¦™ Ollama models:${NC}"
                    curl -s http://localhost:11434/api/tags 2>/dev/null \
                        | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    models = data.get('models', [])
    for m in models:
        size = m.get('size', 0)
        gb = size / 1e9
        print(f'  â— {m[\"name\"]:<35} {gb:.1f} GB')
    print(f'\n  {len(models)} models total')
except: print('  Ollama not running')
" ;;
                pull)
                    local model=${1:-llama3.2}
                    echo "${CYAN}ğŸ¦™ Pulling ${model}...${NC}"
                    ollama pull "$model"
                    ;;
                run)
                    local model=${1:-llama3.2}
                    echo "${CYAN}ğŸ¦™ Running ${model}...${NC}"
                    ollama run "$model"
                    ;;
                stop)
                    pkill -f "ollama serve" 2>/dev/null && echo "${GREEN}âœ“ Ollama stopped${NC}" || echo "${YELLOW}Ollama not running${NC}"
                    ;;
                start)
                    ollama serve > /tmp/ollama.log 2>&1 &
                    sleep 2
                    curl -s http://localhost:11434/api/tags >/dev/null 2>&1 \
                        && echo "${GREEN}âœ“ Ollama started${NC}" || echo "${RED}âœ— Failed to start Ollama${NC}"
                    ;;
                status)
                    curl -s http://localhost:11434/api/tags >/dev/null 2>&1 \
                        && echo "${GREEN}âœ“ Ollama running${NC}" || echo "${RED}âœ— Ollama not running${NC}"
                    ;;
                rm|remove|delete)
                    local model=$1
                    [[ -z "$model" ]] && { echo "${RED}Usage: br ollama rm <model>${NC}"; exit 1; }
                    ollama rm "$model" && echo "${GREEN}âœ“ Removed ${model}${NC}"
                    ;;
                *)
                    echo "Usage: br ollama [list|pull|run|stop|start|status|rm] [model]"
                    ;;
            esac
            ;;
        *)
            # Data-driven tool dispatch
            if dispatch_tool "$cmd" "$@"; then
                return 0
            fi
            echo "Unknown command: $cmd"
            echo "Run 'br help' for usage"
            exit 1
            ;;
    esac
}

main "$@"
